#!/bin/bash -f
# ****************************************************************************
# Vivado (TM) v2021.2 (64-bit)
#
# Filename    : simulate.sh
# Simulator   : Cadence Xcelium Parallel Simulator
# Description : Script for simulating the design by launching the simulator
#
# Generated by Vivado on Fri Apr 18 13:13:42 CEST 2025
# SW Build 3367213 on Tue Oct 19 02:47:39 MDT 2021
#
# IP Build 3369179 on Thu Oct 21 08:25:16 MDT 2021
#
# usage: simulate.sh
#
# ****************************************************************************
set -Eeuo pipefail

START_FAULT_ID=501
END_FAULT_ID=1000
bin_path="/ihp/ihpusr/cadence/xcelium/20.09/tools.lnx86/bin"
xmsim_opts="-64bit"  # Removed global logfile (to avoid conflicts)
NUM_JOBS=14           # Adjust based on CPU cores

run_simulation() {
    local fault_id=$1
    local logfile="fault_${fault_id}.log"
    echo "[$(date)] Starting Fault ID: $fault_id" | tee -a "$logfile"
    
    fi_opts="-fault_sim_run -fault_checker_on -fault_timeout 1000ns -fault_test strobe_test2 -fault_tw 50ns:350ns -fault_strobe_data detect_verbose -fault_id $fault_id -fault_work fault_db2"
    
    if [ "$fault_id" -eq "$END_FAULT_ID" ]; then
        $bin_path/xmsim $xmsim_opts $fi_opts xil_defaultlib.mapper_tb -input mapper_tb_simulate_last_2.do >> "$logfile" 2>&1
    else
        $bin_path/xmsim $xmsim_opts $fi_opts xil_defaultlib.mapper_tb -input mapper_tb_simulate.do >> "$logfile" 2>&1
    fi
    
    echo "[$(date)] Finished Fault ID: $fault_id (Exit status: $?)" | tee -a "$logfile"
}

export -f run_simulation
export bin_path xmsim_opts END_FAULT_ID

seq $START_FAULT_ID $END_FAULT_ID | xargs -n 1 -P $NUM_JOBS -I {} bash -c 'run_simulation {}'
echo "All simulations completed. Check individual .log files."
