#!/bin/bash -f
# ****************************************************************************
# Vivado (TM) v2021.2 (64-bit)
#
# Filename    : simulate.sh
# Simulator   : Cadence Xcelium Parallel Simulator
# Description : Script for simulating the design by launching the simulator
#
# Generated by Vivado on Fri Apr 18 13:13:42 CEST 2025
# SW Build 3367213 on Tue Oct 19 02:47:39 MDT 2021
#
# IP Build 3369179 on Thu Oct 21 08:25:16 MDT 2021
#
# usage: simulate.sh
#
# ****************************************************************************
set -Eeuo pipefail
# === Ranges of Fault IDs to Inject ===
RANGES=(
      "8 13"
    "3197 3687"
)

# Installation path setting
bin_path="/ihp/ihpusr/cadence/xcelium/20.09/tools.lnx86/bin"

# xmsim command line args (removed global logfile to avoid conflicts)
xmsim_opts="-64bit"

# Number of parallel jobs (adjust based on CPU cores)
NUM_JOBS=76

# Function to run a single simulation (no log files)
run_simulation() {
    local fault_id=$1
    
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting Fault ID: $fault_id"
    
    # Set fault injection parameters
    local fi_opts="-fault_sim_run -fault_checker_on -fault_timeout 1000ns  -fault_tw 50ns:450ns  -fault_id $fault_id -fault_work fault_db"
    
    $bin_path/xmsim $xmsim_opts $fi_opts xil_defaultlib.mapper_tb -input mapper_tb_simulate.do > /dev/null 2>&1
    
    exit_status=$?
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Finished Fault ID: $fault_id (Exit status: $exit_status)"
    return $exit_status
}

# Export function and variables for parallel execution
export -f run_simulation
export bin_path xmsim_opts

# Generate all fault IDs from the specified ranges
fault_ids=()
for range in "${RANGES[@]}"; do
    read start end <<< "$range"
    fault_ids+=($(seq $start $end))
done

# Run simulations in parallel using xargs
printf "%s\n" "${fault_ids[@]}" | xargs -n 1 -P $NUM_JOBS -I {} bash -c 'run_simulation {}'

echo "All simulations completed. No log files were saved."


    #Fault sim. commands definition :
    #-fault_sim_run: Enables serial fault simulation. Xcelium injects only a single fault for each fault simulation run.
   # -fault_timeout: Specifies the time, as an absolute time value, to terminate the simulation.
   # -fault_checker_on : Enables the alternative fault detection technique for the fs_strobe command.If you define strobe points to monitor as functional and checker outputs during the good simulation run,
   # those strobe points are used to help classify detected faults during fault simulation.
   # -fault_id: Injects faults by internal ID. With Xcelium, you can inject faults by an internal ID that corresponds to a unique fault node or by some random ID
   # -fault_work : Specifies a name for the output directory in which to save the results of each fault run.
  


    

#print="xfr -fault_work fault_db -fault_report  fault_report_test"
 #$bin_path/xmsim $print

